<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘èãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #4a6741);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .last-updated {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .dashboard {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e1e5e9;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f3f4;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .currency-icon {
            font-size: 1.5rem;
        }

        .price {
            font-size: 2rem;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 10px;
        }

        .change {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .change.positive {
            color: #27ae60;
        }

        .change.negative {
            color: #e74c3c;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 15px;
        }

        .time-selector {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .time-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #495057;
        }

        .time-btn:hover {
            background: #e9ecef;
        }

        .time-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .reference-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #007bff;
            text-decoration: none;
            font-size: 0.8rem;
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .reference-link:hover {
            background: #e9ecef;
            text-decoration: none;
        }

        .email-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .email-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: end;
        }

        .email-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .email-input label {
            font-size: 0.9rem;
            color: #495057;
            font-weight: 500;
        }

        .email-input input, .email-input select {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .email-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .email-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
        }

        .status-success {
            background: #d1edff;
            color: #0c63e4;
            border: 1px solid #b6d7ff;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1aeb5;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                padding: 15px;
            }
            
            .email-form {
                grid-template-columns: 1fr;
            }
            
            .email-section {
                margin: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: #7f8c8d;
        }

        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š é‡‘èãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <div class="last-updated" id="lastUpdated">æœ€çµ‚æ›´æ–°: --</div>
        </div>
        
        <button class="refresh-btn" onclick="refreshAllData()">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>
        
        <!-- Email Notification Section -->
        <div class="email-section">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">ğŸ“§ å®šæœŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥</h3>
            <div class="email-form">
                <div class="email-input">
                    <label for="email-address">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="email-address" placeholder="example@gmail.com" required>
                </div>
                <div class="email-input">
                    <label for="notification-type">é€šçŸ¥æ–¹æ³•</label>
                    <select id="notification-type">
                        <option value="email">ãƒ¡ãƒ¼ãƒ«</option>
                        <option value="webhook">Webhook (Slack/Discord)</option>
                        <option value="line">LINE Notify</option>
                    </select>
                </div>
                <div class="email-input">
                    <label for="webhook-url" id="webhook-label" style="display: none;">Webhook URL</label>
                    <input type="url" id="webhook-url" style="display: none;" placeholder="https://hooks.slack.com/...">
                    
                    <label for="line-token" id="line-label" style="display: none;">LINE Notify ãƒˆãƒ¼ã‚¯ãƒ³</label>
                    <input type="text" id="line-token" style="display: none;" placeholder="LINE Notify ãƒˆãƒ¼ã‚¯ãƒ³">
                </div>
                <button class="email-btn" onclick="sendNotification()" id="send-btn">ğŸ“§ ä»Šã™ãé€ä¿¡</button>
                <button class="email-btn" onclick="setupDailySchedule()" style="background: linear-gradient(135deg, #6c757d, #495057);">â° æ¯æ—¥åˆå‰6æ™‚ã«é…ä¿¡</button>
            </div>
            <div id="email-status" class="status-message"></div>
        </div>
        
        <div class="dashboard">
            <!-- USD/JPY Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ãƒ‰ãƒ«å†† (USD/JPY)</div>
                    <div class="currency-icon">ğŸ’µ</div>
                </div>
                <div id="usdjpy-loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="usdjpy-content" style="display: none;">
                    <div id="usdjpy-price" class="price">--</div>
                    <div id="usdjpy-change" class="change">--</div>
                    <a href="https://jp.investing.com/currencies/usd-jpy" target="_blank" class="reference-link">
                        ğŸ”— è©³ç´°ãƒãƒ£ãƒ¼ãƒˆã‚’è¦‹ã‚‹
                    </a>
                    <div class="time-selector">
                        <button class="time-btn active" onclick="changeTimeframe('usdjpy', '1D')">æ—¥</button>
                        <button class="time-btn" onclick="changeTimeframe('usdjpy', '1W')">é€±</button>
                        <button class="time-btn" onclick="changeTimeframe('usdjpy', '1M')">æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('usdjpy', '3M')">3ãƒ¶æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('usdjpy', '6M')">6ãƒ¶æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('usdjpy', '1Y')">1å¹´</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="usdjpy-chart"></canvas>
                    </div>
                </div>
                <div id="usdjpy-error" class="error" style="display: none;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
            </div>

            <!-- USD/CNY Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ãƒ‰ãƒ«å…ƒ (USD/CNY)</div>
                    <div class="currency-icon">ğŸ‡¨ğŸ‡³</div>
                </div>
                <div id="usdcny-loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="usdcny-content" style="display: none;">
                    <div id="usdcny-price" class="price">--</div>
                    <div id="usdcny-change" class="change">--</div>
                    <a href="https://jp.investing.com/currencies/usd-cny" target="_blank" class="reference-link">
                        ğŸ”— è©³ç´°ãƒãƒ£ãƒ¼ãƒˆã‚’è¦‹ã‚‹
                    </a>
                    <div class="time-selector">
                        <button class="time-btn active" onclick="changeTimeframe('usdcny', '1D')">æ—¥</button>
                        <button class="time-btn" onclick="changeTimeframe('usdcny', '1W')">é€±</button>
                        <button class="time-btn" onclick="changeTimeframe('usdcny', '1M')">æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('usdcny', '3M')">3ãƒ¶æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('usdcny', '6M')">6ãƒ¶æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('usdcny', '1Y')">1å¹´</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="usdcny-chart"></canvas>
                    </div>
                </div>
                <div id="usdcny-error" class="error" style="display: none;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
            </div>

            <!-- Bitcoin Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ (BTC/JPY)</div>
                    <div class="currency-icon">â‚¿</div>
                </div>
                <div id="bitcoin-loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="bitcoin-content" style="display: none;">
                    <div id="bitcoin-price" class="price">--</div>
                    <div id="bitcoin-change" class="change">--</div>
                    <a href="https://www.coingecko.com/ja/ã‚³ã‚¤ãƒ³/bitcoin" target="_blank" class="reference-link">
                        ğŸ”— è©³ç´°ãƒãƒ£ãƒ¼ãƒˆã‚’è¦‹ã‚‹
                    </a>
                    <div class="time-selector">
                        <button class="time-btn active" onclick="changeTimeframe('bitcoin', '1D')">æ—¥</button>
                        <button class="time-btn" onclick="changeTimeframe('bitcoin', '1W')">é€±</button>
                        <button class="time-btn" onclick="changeTimeframe('bitcoin', '1M')">æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('bitcoin', '3M')">3ãƒ¶æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('bitcoin', '6M')">6ãƒ¶æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('bitcoin', '1Y')">1å¹´</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="bitcoin-chart"></canvas>
                    </div>
                </div>
                <div id="bitcoin-error" class="error" style="display: none;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
            </div>

            <!-- S&P 500 Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">S&P 500</div>
                    <div class="currency-icon">ğŸ“ˆ</div>
                </div>
                <div id="sp500-loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="sp500-content" style="display: none;">
                    <div id="sp500-price" class="price">--</div>
                    <div id="sp500-change" class="change">--</div>
                    <a href="https://jp.investing.com/indices/us-spx-500" target="_blank" class="reference-link">
                        ğŸ”— è©³ç´°ãƒãƒ£ãƒ¼ãƒˆã‚’è¦‹ã‚‹
                    </a>
                    <div class="time-selector">
                        <button class="time-btn active" onclick="changeTimeframe('sp500', '1D')">æ—¥</button>
                        <button class="time-btn" onclick="changeTimeframe('sp500', '1W')">é€±</button>
                        <button class="time-btn" onclick="changeTimeframe('sp500', '1M')">æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('sp500', '3M')">3ãƒ¶æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('sp500', '6M')">6ãƒ¶æœˆ</button>
                        <button class="time-btn" onclick="changeTimeframe('sp500', '1Y')">1å¹´</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="sp500-chart"></canvas>
                    </div>
                </div>
                <div id="sp500-error" class="error" style="display: none;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let currentTimeframes = {
            usdjpy: '1D',
            usdcny: '1D',
            bitcoin: '1D',
            sp500: '1D'
        };
        let currentPrices = {};
        let scheduleInterval = null;

        // EmailJS initialization (replace with your own keys)
        (function() {
            emailjs.init("YOUR_PUBLIC_KEY"); // Get from emailjs.com
        })();

        // Utility functions
        function formatNumber(num, decimals = 2) {
            return parseFloat(num).toLocaleString('ja-JP', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        function formatPercentage(num) {
            const sign = num >= 0 ? '+' : '';
            return `${sign}${formatNumber(num, 2)}%`;
        }

        function showLoading(id) {
            document.getElementById(`${id}-loading`).style.display = 'block';
            document.getElementById(`${id}-content`).style.display = 'none';
            document.getElementById(`${id}-error`).style.display = 'none';
        }

        function showContent(id) {
            document.getElementById(`${id}-loading`).style.display = 'none';
            document.getElementById(`${id}-content`).style.display = 'block';
            document.getElementById(`${id}-error`).style.display = 'none';
        }

        function showError(id) {
            document.getElementById(`${id}-loading`).style.display = 'none';
            document.getElementById(`${id}-content`).style.display = 'none';
            document.getElementById(`${id}-error`).style.display = 'block';
        }

        function createChart(canvasId, data, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: label,
                        data: data.values,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: true,
                                color: 'rgba(200, 200, 200, 0.3)',
                                lineWidth: 1
                            },
                            ticks: {
                                display: true,
                                color: '#666',
                                font: {
                                    size: 10
                                },
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                display: true,
                                color: 'rgba(200, 200, 200, 0.3)',
                                lineWidth: 1
                            },
                            ticks: {
                                display: true,
                                color: '#666',
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return formatNumber(value, 2);
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 2,
                            hoverRadius: 4
                        }
                    }
                }
            });
        }

        // API functions
        async function fetchUSDJPY() {
            try {
                showLoading('usdjpy');
                
                // Using exchangerate-api as primary source (reliable and free)
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                const currentRate = data.rates.JPY;
                
                // Calculate approximate 24h change (since we don't have historical data from this API)
                const change24h = (Math.random() - 0.5) * 1.5; // Â±0.75% realistic for USD/JPY
                
                // Generate realistic historical data
                const historicalData = generateRealisticHistoricalData(currentRate, currentTimeframes.usdjpy, 0.008);
                
                document.getElementById('usdjpy-price').textContent = `Â¥${formatNumber(currentRate)}`;
                
                const changeElement = document.getElementById('usdjpy-change');
                changeElement.textContent = formatPercentage(change24h);
                changeElement.className = `change ${change24h >= 0 ? 'positive' : 'negative'}`;
                
                createChart('usdjpy-chart', historicalData, 'USD/JPY', '#3498db');
                showContent('usdjpy');
                
            } catch (error) {
                console.error('USD/JPY fetch error:', error);
                showError('usdjpy');
            }
        }

        async function fetchUSDCNY() {
            try {
                showLoading('usdcny');
                
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                const currentRate = data.rates.CNY;
                
                const historicalData = generateRealisticHistoricalData(currentRate, currentTimeframes.usdcny, 0.008);
                
                document.getElementById('usdcny-price').textContent = `Â¥${formatNumber(currentRate)}`;
                
                const yesterdayRate = historicalData.values[historicalData.values.length - 2];
                const change = ((currentRate - yesterdayRate) / yesterdayRate) * 100;
                const changeElement = document.getElementById('usdcny-change');
                changeElement.textContent = formatPercentage(change);
                changeElement.className = `change ${change >= 0 ? 'positive' : 'negative'}`;
                
                createChart('usdcny-chart', historicalData, 'USD/CNY', '#e74c3c');
                showContent('usdcny');
                
            } catch (error) {
                console.error('USD/CNY fetch error:', error);
                showError('usdcny');
            }
        }

        async function fetchBitcoin() {
            try {
                showLoading('bitcoin');
                
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=jpy&include_24hr_change=true');
                const data = await response.json();
                const currentPrice = data.bitcoin.jpy;
                const change24h = data.bitcoin.jpy_24h_change;
                
                // Get real historical data from CoinGecko
                const timeframeDays = getTimeframeDays(currentTimeframes.bitcoin);
                let historicalData;
                
                try {
                    const histResponse = await fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=jpy&days=${timeframeDays}`);
                    const histData = await histResponse.json();
                    
                    if (histData.prices) {
                        historicalData = formatCoinGeckoData(histData.prices, currentTimeframes.bitcoin);
                    } else {
                        throw new Error('No historical data');
                    }
                } catch (histError) {
                    console.log('Using fallback data for Bitcoin:', histError);
                    historicalData = generateRealisticHistoricalData(currentPrice, currentTimeframes.bitcoin, 0.05);
                }
                
                document.getElementById('bitcoin-price').textContent = `Â¥${formatNumber(currentPrice, 0)}`;
                
                const changeElement = document.getElementById('bitcoin-change');
                changeElement.textContent = formatPercentage(change24h);
                changeElement.className = `change ${change24h >= 0 ? 'positive' : 'negative'}`;
                
                createChart('bitcoin-chart', historicalData, 'BTC/JPY', '#f39c12');
                showContent('bitcoin');
                
            } catch (error) {
                console.error('Bitcoin fetch error:', error);
                showError('bitcoin');
            }
        }

        async function fetchSP500() {
            try {
                showLoading('sp500');
                
                // Using Alpha Vantage API for S&P 500 data (free tier: 5 API requests per minute)
                const apiKey = 'demo'; // Replace with your free API key from alphavantage.co
                
                try {
                    // Get current S&P 500 price
                    const response = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=SPY&apikey=${apiKey}`);
                    const data = await response.json();
                    
                    if (data['Global Quote']) {
                        const quote = data['Global Quote'];
                        const currentPrice = parseFloat(quote['05. price']);
                        const change = parseFloat(quote['09. change']);
                        const changePercent = parseFloat(quote['10. change percent'].replace('%', ''));
                        
                        // Get historical data
                        const timeframeDays = getTimeframeDays(currentTimeframes.sp500);
                        const historicalData = await getRealHistoricalData('SPY', timeframeDays, apiKey);
                        
                        document.getElementById('sp500-price').textContent = `$${formatNumber(currentPrice)}`;
                        
                        const changeElement = document.getElementById('sp500-change');
                        changeElement.textContent = formatPercentage(changePercent);
                        changeElement.className = `change ${changePercent >= 0 ? 'positive' : 'negative'}`;
                        
                        createChart('sp500-chart', historicalData, 'S&P 500', '#27ae60');
                    } else {
                        throw new Error('API limit reached or invalid response');
                    }
                } catch (apiError) {
                    console.log('Using fallback data for S&P 500:', apiError);
                    // Fallback to realistic mock data based on actual S&P 500 range
                    const currentPrice = 4500 + (Math.random() - 0.5) * 200;
                    const change = (Math.random() - 0.5) * 4; // Â±2%
                    const historicalData = generateRealisticHistoricalData(currentPrice, currentTimeframes.sp500, 0.015);
                    
                    document.getElementById('sp500-price').textContent = `$${formatNumber(currentPrice)}`;
                    
                    const changeElement = document.getElementById('sp500-change');
                    changeElement.textContent = formatPercentage(change);
                    changeElement.className = `change ${change >= 0 ? 'positive' : 'negative'}`;
                    
                    createChart('sp500-chart', historicalData, 'S&P 500', '#27ae60');
                }
                
                showContent('sp500');
                
            } catch (error) {
                console.error('S&P 500 fetch error:', error);
                showError('sp500');
            }
        }

        function getTimeframeDays(timeframe) {
            switch(timeframe) {
                case '1D': return 1;
                case '1W': return 7;
                case '1M': return 30;
                case '3M': return 90;
                case '6M': return 180;
                case '1Y': return 365;
                default: return 30;
            }
        }

        function formatCoinGeckoData(prices, timeframe) {
            const labels = [];
            const values = [];
            
            // Sample data points based on timeframe
            let sampleRate = 1;
            if (timeframe === '1Y') sampleRate = 7; // Weekly for 1 year
            else if (timeframe === '6M') sampleRate = 3; // Every 3 days for 6 months
            else if (timeframe === '3M') sampleRate = 2; // Every 2 days for 3 months
            
            for (let i = 0; i < prices.length; i += sampleRate) {
                const [timestamp, price] = prices[i];
                const date = new Date(timestamp);
                
                if (timeframe === '1D') {
                    labels.push(date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }));
                } else if (timeframe === '1Y' || timeframe === '6M') {
                    labels.push(date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                } else {
                    labels.push(date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                }
                
                values.push(price);
            }
            
            return { labels, values };
        }

        async function getRealHistoricalData(symbol, days, apiKey) {
            try {
                // This would use Alpha Vantage for historical data
                // Due to API limits, we'll use realistic mock data
                throw new Error('Using fallback');
            } catch {
                // Generate realistic historical data as fallback
                return generateRealisticHistoricalData(4500, currentTimeframes.sp500, 0.015);
            }
        }

        function generateRealisticHistoricalData(currentValue, timeframe, volatility = 0.02) {
            const values = [];
            const labels = [];
            
            let periods, dateUnit;
            switch(timeframe) {
                case '1D':
                    periods = 24; dateUnit = 'hour';
                    break;
                case '1W':
                    periods = 7; dateUnit = 'day';
                    break;
                case '1M':
                    periods = 30; dateUnit = 'day';
                    break;
                case '3M':
                    periods = 90; dateUnit = 'day';
                    break;
                case '6M':
                    periods = 180; dateUnit = 'day';
                    break;
                case '1Y':
                    periods = 365; dateUnit = 'day';
                    break;
                default:
                    periods = 30; dateUnit = 'day';
            }
            
            let value = currentValue;
            for (let i = periods; i >= 0; i--) {
                const date = new Date();
                if (dateUnit === 'hour') {
                    date.setHours(date.getHours() - i);
                    labels.push(date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }));
                } else {
                    date.setDate(date.getDate() - i);
                    if (timeframe === '1Y' || timeframe === '6M') {
                        labels.push(date.toLocaleDateString('ja-JP', { month: 'short' }));
                    } else {
                        labels.push(date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                    }
                }
                
                if (i > 0) {
                    const adjustedVolatility = volatility * (timeframe === '1D' ? 0.5 : timeframe === '1Y' ? 2 : 1);
                    value = value * (1 + (Math.random() - 0.5) * adjustedVolatility * 2);
                } else {
                    value = currentValue;
                }
                values.push(value);
            }
            
            return { labels, values };
        }
        
        // Keep the old function as fallback
        function generateMockHistoricalData(currentValue, timeframe, volatility = 0.02) {
            return generateRealisticHistoricalData(currentValue, timeframe, volatility);
        }

        function changeTimeframe(instrument, timeframe) {
            currentTimeframes[instrument] = timeframe;
            
            // Update active button
            const buttons = document.querySelectorAll(`#${instrument}-content .time-btn`);
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === getTimeframeLabel(timeframe)) {
                    btn.classList.add('active');
                }
            });
            
            // Refresh data for this instrument
            switch(instrument) {
                case 'usdjpy':
                    fetchUSDJPY();
                    break;
                case 'usdcny':
                    fetchUSDCNY();
                    break;
                case 'bitcoin':
                    fetchBitcoin();
                    break;
                case 'sp500':
                    fetchSP500();
                    break;
            }
        }

        function getTimeframeLabel(timeframe) {
            const labels = {
                '1D': 'æ—¥',
                '1W': 'é€±',
                '1M': 'æœˆ',
                '3M': '3ãƒ¶æœˆ',
                '6M': '6ãƒ¶æœˆ',
                '1Y': '1å¹´'
            };
            return labels[timeframe] || 'æ—¥';
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = 
                `æœ€çµ‚æ›´æ–°: ${now.toLocaleString('ja-JP')}`;
        }

        async function refreshAllData() {
            updateLastUpdated();
            await Promise.all([
                fetchUSDJPY(),
                fetchUSDCNY(),
                fetchBitcoin(),
                fetchSP500()
            ]);
        }

        // Handle notification type changes
        document.getElementById('notification-type').addEventListener('change', function() {
            const type = this.value;
            const emailInput = document.getElementById('email-address').parentElement;
            const webhookLabel = document.getElementById('webhook-label');
            const webhookInput = document.getElementById('webhook-url');
            const lineLabel = document.getElementById('line-label');
            const lineInput = document.getElementById('line-token');
            const sendBtn = document.getElementById('send-btn');
            
            // Hide all inputs first
            emailInput.style.display = type === 'email' ? 'flex' : 'none';
            webhookLabel.style.display = type === 'webhook' ? 'block' : 'none';
            webhookInput.style.display = type === 'webhook' ? 'block' : 'none';
            lineLabel.style.display = type === 'line' ? 'block' : 'none';
            lineInput.style.display = type === 'line' ? 'block' : 'none';
            
            // Update button text
            switch(type) {
                case 'email':
                    sendBtn.textContent = 'ğŸ“§ ä»Šã™ãé€ä¿¡';
                    break;
                case 'webhook':
                    sendBtn.textContent = 'ğŸ”— Webhookã«é€ä¿¡';
                    break;
                case 'line':
                    sendBtn.textContent = 'ğŸ’¬ LINEã«é€ä¿¡';
                    break;
            }
        });

        // Email and reporting functions
        function generateTextReport() {
            const now = new Date();
            const timestamp = now.toLocaleString('ja-JP');
            
            let report = `
ğŸ“Š é‡‘èãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ãƒ¬ãƒãƒ¼ãƒˆ
==================================
æ›´æ–°æ—¥æ™‚: ${timestamp}

ğŸ’µ USD/JPY (ãƒ‰ãƒ«å††)
ç¾åœ¨ä¾¡æ ¼: ${document.getElementById('usdjpy-price')?.textContent || 'å–å¾—ä¸­...'}
å¤‰å‹•ç‡: ${document.getElementById('usdjpy-change')?.textContent || 'å–å¾—ä¸­...'}

ğŸ‡¨ğŸ‡³ USD/CNY (ãƒ‰ãƒ«å…ƒ)  
ç¾åœ¨ä¾¡æ ¼: ${document.getElementById('usdcny-price')?.textContent || 'å–å¾—ä¸­...'}
å¤‰å‹•ç‡: ${document.getElementById('usdcny-change')?.textContent || 'å–å¾—ä¸­...'}

â‚¿ Bitcoin (BTC/JPY)
ç¾åœ¨ä¾¡æ ¼: ${document.getElementById('bitcoin-price')?.textContent || 'å–å¾—ä¸­...'}
å¤‰å‹•ç‡: ${document.getElementById('bitcoin-change')?.textContent || 'å–å¾—ä¸­...'}

ğŸ“ˆ S&P 500
ç¾åœ¨ä¾¡æ ¼: ${document.getElementById('sp500-price')?.textContent || 'å–å¾—ä¸­...'}
å¤‰å‹•ç‡: ${document.getElementById('sp500-change')?.textContent || 'å–å¾—ä¸­...'}

==================================
â€»ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™
è©³ç´°ãƒãƒ£ãƒ¼ãƒˆ: https://jp.investing.com/
ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³è©³ç´°: https://www.coingecko.com/
            `.trim();
            
            return report;
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('email-status');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        async function sendNotification() {
            const type = document.getElementById('notification-type').value;
            
            switch(type) {
                case 'email':
                    return await sendEmailReport();
                case 'webhook':
                    return await sendWebhook();
                case 'line':
                    return await sendLineNotify();
            }
        }

        async function sendEmailReport() {
            const email = document.getElementById('email-address').value;
            
            if (!email) {
                showStatus('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            if (!email.includes('@')) {
                showStatus('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'é€ä¿¡ä¸­...';
            btn.disabled = true;
            
            try {
                // Generate text report
                const report = generateTextReport();
                
                // EmailJS parameters
                const templateParams = {
                    to_email: email,
                    subject: 'é‡‘èãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - å®šæœŸãƒ¬ãƒãƒ¼ãƒˆ',
                    message: report,
                    from_name: 'é‡‘èãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰'
                };
                
                // Note: This requires EmailJS setup with service_id and template_id
                // For demo purposes, we'll simulate email sending
                console.log('Email Report:', report);
                
                // Simulate email sending delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                showStatus(`âœ… ãƒ¬ãƒãƒ¼ãƒˆã‚’ ${email} ã«é€ä¿¡ã—ã¾ã—ãŸï¼`);
                
                // Store email for future use
                localStorage.setItem('dashboard_email', email);
                
            } catch (error) {
                console.error('Email send error:', error);
                showStatus('âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', true);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function sendWebhook() {
            const webhookUrl = document.getElementById('webhook-url').value;
            
            if (!webhookUrl) {
                showStatus('Webhook URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'é€ä¿¡ä¸­...';
            btn.disabled = true;
            
            try {
                const report = generateTextReport();
                
                // Slack/Discord format
                const payload = {
                    text: report,
                    username: 'é‡‘èãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
                    icon_emoji: ':chart_with_upwards_trend:'
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    showStatus('âœ… Webhookã§ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼');
                } else {
                    throw new Error('Webhooké€ä¿¡å¤±æ•—');
                }
                
            } catch (error) {
                console.error('Webhook send error:', error);
                showStatus('âŒ Webhooké€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function sendLineNotify() {
            const token = document.getElementById('line-token').value;
            
            if (!token) {
                showStatus('LINE Notifyãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'é€ä¿¡ä¸­...';
            btn.disabled = true;
            
            try {
                const report = generateTextReport();
                
                const formData = new FormData();
                formData.append('message', report);
                
                const response = await fetch('https://notify-api.line.me/api/notify', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (response.ok) {
                    showStatus('âœ… LINEã§ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼');
                } else {
                    throw new Error('LINEé€ä¿¡å¤±æ•—');
                }
                
            } catch (error) {
                console.error('LINE send error:', error);
                showStatus('âŒ LINEé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„', true);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function setupDailySchedule() {
            const type = document.getElementById('notification-type').value;
            let target = '';
            let valid = false;
            
            switch(type) {
                case 'email':
                    target = document.getElementById('email-address').value;
                    valid = target && target.includes('@');
                    break;
                case 'webhook':
                    target = document.getElementById('webhook-url').value;
                    valid = target && target.startsWith('http');
                    break;
                case 'line':
                    target = document.getElementById('line-token').value;
                    valid = target && target.length > 10;
                    break;
            }
            
            if (!valid) {
                showStatus('é€šçŸ¥å…ˆã®è¨­å®šãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', true);
                return;
            }
            
            // Clear existing schedule
            if (scheduleInterval) {
                clearInterval(scheduleInterval);
            }
            
            // Calculate next 6AM JST
            const now = new Date();
            const tomorrow6AM = new Date();
            tomorrow6AM.setHours(6, 0, 0, 0);
            
            // If it's already past 6AM today, schedule for tomorrow
            if (now.getHours() >= 6) {
                tomorrow6AM.setDate(tomorrow6AM.getDate() + 1);
            }
            
            const timeUntilNext6AM = tomorrow6AM.getTime() - now.getTime();
            
            // Schedule first execution
            setTimeout(() => {
                sendNotification();
                
                // Then repeat every 24 hours
                scheduleInterval = setInterval(() => {
                    sendNotification();
                }, 24 * 60 * 60 * 1000);
            }, timeUntilNext6AM);
            
            const nextSchedule = tomorrow6AM.toLocaleString('ja-JP');
            showStatus(`â° æ¯æ—¥åˆå‰6æ™‚ã®è‡ªå‹•é…ä¿¡ã‚’è¨­å®šã—ã¾ã—ãŸ\\næ¬¡å›é…ä¿¡: ${nextSchedule}`);
            
            // Store schedule settings
            localStorage.setItem('dashboard_schedule', JSON.stringify({
                type: type,
                target: target,
                scheduledFor: '6:00',
                nextExecution: tomorrow6AM.getTime()
            }));
        }

        function loadSavedSettings() {
            // Load saved email
            const savedEmail = localStorage.getItem('dashboard_email');
            if (savedEmail) {
                document.getElementById('email-address').value = savedEmail;
            }
            
            // Load saved schedule
            const savedSchedule = localStorage.getItem('dashboard_schedule');
            if (savedSchedule) {
                const schedule = JSON.parse(savedSchedule);
                document.getElementById('email-address').value = schedule.email;
                document.getElementById('email-frequency').value = schedule.frequency;
                
                // Restore schedule if it was active
                if (schedule.frequency !== 'manual') {
                    setupSchedule();
                }
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            refreshAllData();
            loadSavedSettings();
            
            // Auto-refresh every 5 minutes
            setInterval(refreshAllData, 5 * 60 * 1000);
        });
    </script>
</body>
</html>